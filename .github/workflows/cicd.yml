name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Lint and Test
  test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
        python -m pip install pylint bandit pytest
    
    - name: Lint with pylint
      run: |
        pylint app.py --disable=C0114,C0115,C0116 || true
    
    - name: Run unit tests
      run: |
        python -m pytest tests/ -v --tb=short
  
  # Job 2: SAST Security Scan
  sast:
    name: SAST Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install Bandit
      run: python -m pip install bandit
    
    - name: Run Bandit SAST scan
      run: |
        python -m bandit -r app.py -f json -o bandit-report.json || true
        python -m bandit -r app.py
    
    - name: Upload SAST results
      uses: actions/upload-artifact@v4
      with:
        name: sast-report
        path: bandit-report.json
  
  # Job 3: Build and Push Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, sast]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # - name: Log in to Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKER_USERNAME }}
    #     password: ${{ secrets.DOCKER_PASSWORD }}
    #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    - name: Build Docker image
      run: |
        docker build -t assignment-api:${{ github.sha }} .
        docker tag assignment-api:${{ github.sha }} assignment-api:latest
    
    # - name: Push to Docker Hub
    #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    #   run: |
    #     docker tag assignment-api:latest ${{ secrets.DOCKER_USERNAME }}/assignment-api:latest
    #     docker tag assignment-api:latest ${{ secrets.DOCKER_USERNAME }}/assignment-api:${{ github.sha }}
    #     docker push ${{ secrets.DOCKER_USERNAME }}/assignment-api:latest
    #     docker push ${{ secrets.DOCKER_USERNAME }}/assignment-api:${{ github.sha }}
    
    - name: Save Docker image
      run: |
        docker save assignment-api:latest -o assignment-api.tar
    
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: assignment-api.tar
  
  # Job 4: DAST Security Scan
  dast:
    name: DAST Security Scan
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
    
    - name: Load Docker image
      run: docker load -i assignment-api.tar
    
    - name: Run container for DAST scan
      run: |
        docker run -d -p 8000:8000 --name test-api assignment-api:latest
        sleep 10
    
    - name: Verify API is running
      run: |
        curl -f http://localhost:8000/health || exit 1
    
    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: 'http://localhost:8000'
        allow_issue_writing: false
        fail_action: false
    
    - name: Stop container
      if: always()
      run: docker stop test-api && docker rm test-api
    
    - name: Upload DAST results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dast-report
        path: report_html.html
  
  # Job 5: Deploy to Kubernetes (optional - for cloud deployments)
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [build, dast]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy notification
      run: |
        echo "Deployment step - configure with your Kubernetes cluster credentials"
        echo "For minikube/local testing, this step can be skipped"
        echo "For cloud deployment, configure kubectl and apply manifests"
    
    # Uncomment and configure for actual cloud deployment
    # - name: Set up kubectl
    #   uses: azure/setup-kubectl@v3
    # 
    # - name: Configure kubectl
    #   run: |
    #     echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig
    #     export KUBECONFIG=kubeconfig
    # 
    # - name: Deploy to Kubernetes
    #   run: |
    #     kubectl apply -f k8s/deployment.yaml
    #     kubectl apply -f k8s/service.yaml
    #     kubectl rollout status deployment/assignment-api
